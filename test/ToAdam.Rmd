---
title: "Per_farmer_page_layout"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(maps)
getwd()
```

### Inputs:
```{r}
fname_data = "C:\\Users\\ALEX\\Desktop\\POP_PHENO_DATA.txt"
name_farmer = "Brent Alexander"

dat = read.delim(fname_data, header=TRUE, na.string="#N/A")
subdat = dat[dat$Farmer_Agronomist==name_farmer, ]
```

### Histograms:
Compared to your neighbour farms,
```{r}
layout(matrix(c(1:8),4,2,byrow = TRUE), TRUE)
par(mfrow=c(4,2))
par(mar=c(1,1,1,1))

list_herbicides = c("Clethodim", "Glyphosate", "Sulfometuron", "Terbuthylazine")

for (name_herbicide in list_herbicides){
  
  resistance = eval(parse(text=paste0("dat$", name_herbicide)))
  resistance = resistance[!is.na(resistance)]
  subdat_resistance = eval(parse(text=paste0("subdat$", name_herbicide))) # load sub-dataset of each farmers
  
  ## Histogram
  if (sum(!is.na(subdat_resistance))==0){
    par(fig=c(0,1,0,.8), mar=c(rep(3,4)), xpd=T, new=F)
    ### if all data in this sub-dataset is NA, print NO DATA
    plot(x=0:1, y=0:1, type="n", xlab=name_herbicide, ylab="")
    text(x=0.5, y=0.5, lab="NO DATA")
  } else {
    ### histogram
    par(fig=c(0,1,0,.8), mar=c(rep(4,4)), xpd=T, new=F)
    h = hist(resistance, plot = F)
    ymax = max(h$counts)
    hist(resistance, col=rgb(0.5,0.5,0.5,alpha=0.6), labels = TRUE, freq=T, breaks=10, bord=FALSE, main="", xlim = c(0,1), xlab=name_herbicide, ylim = c(0,ymax))
    ### grid
    par(fig=c(0,1,0,.8), mar=c(rep(3,4)), xpd=F, new=T)
    grid()
    ### line
    list_percentile = c()
    list_colors = rev(rainbow(nrow(subdat)))
    for (i in 1:nrow(subdat)){
      abline(v=subdat_resistance[i], col=list_colors[i], lwd=2)
      list_percentile = c(list_percentile, sum(resistance>=subdat_resistance[i])/length(resistance))
    }
    ### legend
    par(mar=c(rep(0,4)), xpd=F)
    legend("topright", title="The herbicide resistance situation of your farm in ", legend=paste0(subdat$Location[!is.na(subdat_resistance)], "(", subdat$Accession_Name[!is.na(subdat_resistance)], ") is lower (better) than other ", round(list_percentile[!is.na(subdat_resistance)]*100), "% farms"), col=list_colors[!is.na(subdat_resistance)], pch=c(19,19), box.col = F, cex=.9)
  
  }
  
  ## Map
  if (sum(!is.na(subdat_resistance)) == 0 ){
    next
  }
  
  landscape_gradient = readRDS(paste0("C:/Users/ALEX/Desktop/test1/Herbicide/data/landscape_surfaces_gradient_data_", name_herbicide, ".rds"))
  predx = landscape_gradient$predx
  predy = landscape_gradient$predy
  Z = landscape_gradient$Z
  
  ncolors = 25 ### 25 is a nice number to see dicrete contour lines across the landscape methinks...
  color_gradient = rev(colorRampPalette(c("#A50026","#D73027","#F46D43","#FDAE61","#FEE08B","#FFFFBF","#D9EF8B","#A6D96A","#66BD63","#1A9850","#006837"))(ncolors))
  
  ### define x-y limits
  dx=c(min(predx), max(predx))
  dy=c(min(predy), max(predy))
  xaxis = seq(round(min(predx)), round(max(predx)), 2)
  yaxis = seq(round(min(predy))-2, round(max(predy))+2, 2)
  
  ### prepare the box enclosing the map
  par(fig=c(0,0.9,0,1), mar=c(rep(1,4)), xpd=F, new=F)
  plot(0, xlim=dx, ylim=dy, asp=1, type="n", xlab="Longitude", ylab="Latitdue", main=paste0(name_herbicide, " Resistance Gradient"), xaxt="n", yaxt="n", frame.plot=FALSE) #empty
  ### overlay the heatmap
  par(fig=c(0,0.9,0,1), mar=c(rep(3,4)), xpd=T, new=T)
  image(x=predx, y=predy, z=Z, col=color_gradient[round(min(Z)*ncolors):round(max(Z)*ncolors)], xlab="", ylab="", main="", asp=1, xaxt="n", yaxt="n", frame.plot=FALSE)
  ### extract the bounding box of the map
  outline = maps::map("world", plot=FALSE)
  xrange = range(outline$x, na.rm=TRUE)
  yrange = range(outline$y, na.rm=TRUE)
  xbox = xrange + c(-2, 2)
  ybox = yrange + c(-2, 2)
  ### draw the outline of the map and color the water blue
  par(fig=c(0,0.9,0,1), xpd=F, new=T)
  polypath(c(outline$x, NA, c(xbox, rev(xbox))),
         c(outline$y, NA, rep(ybox, each=2)),
         col="light blue", rule="evenodd")
  ### name the ticks with degree signs ("\U00B0")
  axis(side=1, at=xaxis, labels=paste0(xaxis, "\U00B0"))
  axis(side=2, at=yaxis, labels=paste0(yaxis, "\U00B0"),las=2)
  ### add a grid 'cause it looks nice
  par(fig=c(0,0.9,0,1), xpd=F, new=TRUE)
  grid(col="darkgray")
  ### plot points
  par(fig=c(0,0.9,0,1), xpd=F, new=TRUE)
  plot(0, xlim=dx, ylim=dy, asp=1, type="n", xlab="", ylab="", main="", xaxt="n", yaxt="n") #empty
  for (i in 1:nrow(subdat)){
    x = subdat$Coordinates_E[i]
    y = subdat$Coordinates_N[i]
    r = eval(parse(text=paste0("subdat$", name_herbicide)))[i]
    if (!is.na(r)){
      points(x, y, col="black", bg=color_gradient[round(r*ncolors)+1], pch=19)
      text(x, y, labels=subdat$Accession_Name[i], pos=1)
    }
  }
  
  ### plot heat map legend
  par(fig=c(0.9,1,0.2,0.8), mar=c(rep(1.5,4)), xpd=F, new=TRUE)
  legend_x=seq(from=0,to=1, length=length(color_gradient))
  legend_y=seq(from=0, to=1, length=length(color_gradient))
  legend_z = matrix(rep(legend_x, times=length(color_gradient)), byrow=TRUE, nrow=length(color_gradient))
  plot(x=c(0,1), y=c(0,1), type="n", xlab="", ylab="", xaxt="n", yaxt="n", main="")
  par(new=TRUE)
  image(x=legend_x, y=legend_y, z=legend_z, col=color_gradient, xlab="", ylab="", main="", xaxt="n", las=2)
  mtext("Completely\nResistant", side=3, line=0.5, at=0.5, cex=0.5)
  mtext("Completely\nSusceptible", side=1, line=1.5, at=0.5, cex=0.5)
  
}
```



