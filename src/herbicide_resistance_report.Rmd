---
title: "BASH_REPLACE_WITH_FARMER_NAME"
output:
  pdf_document: default
---
<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r, echo=FALSE}
knitr::opts_chunk$set(dev="png")
```

- Collection date: November 2018
- Herbicides were applied at their respective recommended field rates, 30 days after germination.
- The percentile scores indicate how many populations have resistance levels less than or equal to your populations. (For example, 23rd percentile means that 23% of the populations we tested have resistance levels less than or equal to your population or in other words, your population is less resistant than 77% of the populations we tested.)

```{r, echo=FALSE}
### Herbicide name writing function
plot_herbicide_name = function(name_herbicide, colour_herbicide, cex.title=1, df_herbi_specs, df_farmer, cex.sub=0.5){
  pre_or_post = df_herbi_specs$PRE_POST[df_herbi_specs$HERBICIDE==name_herbicide]
  hrac_group = df_herbi_specs$HRAC[df_herbi_specs$HERBICIDE==name_herbicide]
  au_group = df_herbi_specs$AU[df_herbi_specs$HERBICIDE==name_herbicide]
  subtitle = paste0("[", pre_or_post, "; ", "Group ", au_group, "; HRAC ", hrac_group, "]")
  par(mar=c(0,0,0,0))
  plot(x=c(0,5), y=c(0,5), type="n", xaxt="n", yaxt="n", xlab="", ylab="", bty="n")
  rect(xleft=0, ybottom=0, xright=5, ytop=5, col=colour_herbicide, border=NA)
  text(x=2.5, y=3.5, lab=name_herbicide, cex=cex.title)
  text(x=2.5, y=1, lab=subtitle, cex=cex.sub)
}
# plot_herbicide_name(name_herbicide, colour_herbicide, cex.title=1)
```

```{r, echo=FALSE}
### Histogram plotting function
plot_hist = function(vec_resistance, name_herbicide, colour_herbicide, df_farmer){
  par(mar=c(5,5,1,5))
  obj_hist = hist(vec_resistance*100, col=rgb(0.5,0.5,0.5,alpha=0.6), nclass=10, bord=FALSE, main="", ylab="Number of Populations", xlab=paste0(name_herbicide, " Resistance (%)"), xaxt="n", xlim=c(0,105), las=2)
  axis(side=1, at=seq(0,100,by=20), lab=seq(0,100,by=20))
  grid()
  x = eval(parse(text=paste0("df_farmer$", name_herbicide, "_SURVI*100")))
  y = rev(seq(from=1, to=max(obj_hist$counts)-1, length=10))[1:nrow(df_farmer)]
  vec_labels = paste0(df_farmer$Location, ": ", df_farmer$Coordinates_N, "N, ", df_farmer$Coordinates_E, "E")
  vec_percentiles = c()
  for (i in 1:nrow(df_farmer)){
    # i = 1
    lines(x=c(x[i], x[i]), y=c(0, y[i]), lwd=2, col=colour_herbicide)
    points(x=x[i], y=y[i], bg=colour_herbicide, pch=25)
    text(x=x[i], y=y[i], lab=i, pos=4)
    percentile = round(sum(vec_resistance<=x[i]/100)/length(vec_resistance)*100)
    if ((percentile %% 10)==1 & (percentile>20 | percentile<10)){
      percentile = paste0(percentile, "st")
    } else if ((percentile %% 10)==2 & (percentile>20 | percentile<10)){
      percentile = paste0(percentile, "nd")
    } else if ((percentile %% 10)==3 & (percentile>20 | percentile<10)){
      percentile = paste0(percentile, "rd")
    } else {
      percentile = paste0(percentile, "th")
    }
    vec_percentiles = c(vec_percentiles, paste0(vec_labels[i], " (", percentile, " percentile)"))
  }
  return(vec_percentiles)
}
# vec_percentiles = plot_hist(vec_resistance, name_herbicide, colour_herbicide, df_farmer)
```

```{r, echo=FALSE}
## Population names legend writing function
plot_legend = function(vec_percentiles, colour_herbicide, cex.text=1){
  par(mar=c(1,1,1,5))
  plot(x=c(-1,1), y=c(-1,1), type="n", xaxt="n", yaxt="n", xlab="", ylab="", bty="n")
  legend(x="center", pch=25, pt.bg=colour_herbicide, col=colour_herbicide, legend=paste0(1:length(vec_percentiles), ": ", vec_percentiles), bty="n", cex=cex.text)
}
# plot_legend(vec_percentiles, colour_herbicide)
```

```{r, echo=FALSE}
## Heatmap plotting function
library(maps)
plot_heatmap = function(name_herbicide, df_farmer){
  landscape_gradient = readRDS(paste0("../data/landscape_surfaces_gradient_data_", name_herbicide, ".rds"))
  predx = landscape_gradient$predx
  predy = landscape_gradient$predy
  Z = landscape_gradient$Z
  ### colou specifications
  ncolors = 25 ### 25 is a nice number to see dicrete contour lines across the landscape methinks...
  color_gradient = rev(colorRampPalette(c("#A50026","#D73027","#F46D43","#FDAE61","#FEE08B","#FFFFBF","#D9EF8B","#A6D96A","#66BD63","#1A9850","#006837"))(ncolors))
  ### define x-y limits
  dx=c(min(predx), max(predx))
  dy=c(min(predy), max(predy))
  xaxis = seq(round(min(predx)), round(max(predx)), 2)
  yaxis = seq(round(min(predy))-2, round(max(predy))+2, 2)
  ### prepare the box enclosing the map
  par(mar=c(5,2,1,1))
  plot(0, xlim=dx, ylim=dy, asp=1, type="n", xlab="Longitude", ylab="Latitdue", main="", xaxt="n", yaxt="n") #empty
  ### overlay the heatmap
  par(new=TRUE)
  image(x=predx, y=predy, z=Z, col=color_gradient[round(min(Z)*ncolors):round(max(Z)*ncolors)], xlab="", ylab="", main="", asp=1, xaxt="n", yaxt="n")
  ### extract the bounding box of the map
  outline = maps::map("world", plot=FALSE)
  xrange = range(outline$x, na.rm=TRUE)
  yrange = range(outline$y, na.rm=TRUE)
  xbox = xrange + c(-2, 2)
  ybox = yrange + c(-2, 2)
  ### draw the outline of the map and color the water blue
  polypath(c(outline$x, NA, c(xbox, rev(xbox))),
         c(outline$y, NA, rep(ybox, each=2)),
         col="light blue", rule="evenodd")
  ### name the ticks with degree signs ("\U00B0")
  axis(side=1, at=xaxis, labels=paste0(xaxis, "\U00B0"))
  axis(side=2, at=yaxis, labels=paste0(yaxis, "\U00B0"),las=2)
  ### add a grid 'cause it looks noice
  grid(col="darkgray")
  ### plot points
  par(new=TRUE)
  plot(0, xlim=dx, ylim=dy, asp=1, type="n", xlab="", ylab="", main="", xaxt="n", yaxt="n") #empty
  # plot(0, xlim=dx, ylim=dy, asp=1, type="n", xlab="", ylab="", main="")
  for (i in 1:nrow(df_farmer)){
    x = df_farmer$Coordinates_E[i]
    y = df_farmer$Coordinates_N[i]
    r = eval(parse(text=paste0("df_farmer$", name_herbicide, "_SURVI")))[i]
    if (!is.na(r)){
      points(x, y, col="black", bg=color_gradient[round(r*ncolors)+1], pch=19)
      ### draw arrows and number labels
      if (median(df_farmer$Coordinates_E)<144){
        x1 = x-(i*0.75)
        y1 = y-(median(1:nrow(df_farmer))-(i*0.75))
      } else {
        x1 = x-(i*0.75)
        y1 = y-(median(1:nrow(df_farmer))-(i*0.75))
      }
      arrows(x0=x, y0=y, x1=x1, y1=y1, length=0.15)
      text(x1, y1, lab=i, pos=2)
    }
  }
  return(color_gradient)
}
# color_gradient = plot_heatmap(name_herbicide, df_farmer)
```

```{r, echo=FALSE}
## Heat map legend plotting function
plot_heatmap_legend = function(color_gradient){
  legend_x=seq(from=0,to=1, length=length(color_gradient))
  legend_y=seq(from=0, to=100, length=length(color_gradient))
  legend_z = matrix(rep(legend_x, times=length(color_gradient)), byrow=TRUE, nrow=length(color_gradient))
  par(mar=c(3,3,3,1))
  plot(x=c(0,100), y=c(0,100), type="n", xlab="", ylab="", xaxt="n", yaxt="n", main="")
  par(new=TRUE)
  image(x=legend_x, y=legend_y, z=legend_z, col=color_gradient, xlab="", ylab="", main="", xaxt="n", las=2)
  mtext("Resistant", side=3, line=0.5, at=0.5, cex=0.75)
  mtext("Susceptible", side=1, line=1.5, at=0.5, cex=0.75)
}
# plot_heatmap_legend(color_gradient)
```

```{r, echo=FALSE}
### Assay description
plot_description = function(name_herbicide, colour_herbicide, df_herbi_specs, df_farmer, cex.text=1, width=75){
  commercial_name = df_herbi_specs$COMMERCIAL_NAME[df_herbi_specs$HERBICIDE==name_herbicide]
  application_rate = df_herbi_specs$RATE[df_herbi_specs$HERBICIDE==name_herbicide]
  par(mar=c(0,0,0,0))
  plot(x=c(-1,1), y=c(-1,1), type="n", xaxt="n", yaxt="n", xlab="", ylab="", bty="n")
  rect(xleft=-1, ybottom=-1, xright=1, ytop=1, col=colour_herbicide, border=NA)
  
  DESCRIPTION = c(paste(strwrap(paste0("We used ", commercial_name, " at ", application_rate, " g active ingredient per hectare."), width=width), collapse="\n"),
                  "The number of plants tested per population were:",
                  paste0("\t- Population ", 1:nrow(df_farmer), " = ", eval(parse(text=paste0("df_farmer$", name_herbicide, "_sampleSize"))))
                  )
  if (nrow(df_farmer)==1){
    DESCRIPTION[2] = sub("The number of plants tested per population were:", "The number of plants tested on your population was:", DESCRIPTION[2])
  }
  text(x=-1, y=-0.25, lab=paste0(DESCRIPTION, collapse="\n"), cex=cex.text, pos=4)
  
}

```

```{r, echo=FALSE, fig.height=13, fig.width=20, dpi=200}
### EXECUTIONER

### (1) Inputs
fname_data = "../data/Lrigidum_RESISTANCES_2018-11.csv"
fname_herbi_specs = "../data/Lrigidum_HERBICIDES_2018-11.csv"

dat = read.csv(fname_data, header=TRUE, na.string="NA")
df_herbi_specs = read.csv(fname_herbi_specs)

name_farmer = "BASH_REPLACE_WITH_FARMER_NAME"
### test
name_farmer = "Kim Lyons (thru Andrew Speirs)"

### Plots layout
r = 5 ### 5 columns for the main plots
rl = 1 ### 1 column for the heatmap legend
l1 = 1 ### title row
l2 = 4 ### main plots top rows
l3 = 2 ### main plots bottom rows
l4 = 4 ### description row
l5 = 1 ### spacer row
LAYOUT = matrix(c(rep(1, l1*((2*r)+rl)),
                  rep( c(rep(2,r), rep(4,r), rep(5,rl)), times=l2 ), 
                  rep( c(rep(3,r), rep(4,r), rep(5,rl)), times=l3 ),
                  rep(6, l4*((2*r)+rl)), 
                  rep(7, l5*((2*r)+rl))), nrow=l1+l2+l3+l4+l5, byrow=TRUE)
layout(LAYOUT)
par(cex=1.5)

### herbicide names and colours
list_herbicides = c("Clethodim", "Glyphosate", "Sulfometuron", "Terbuthylazine")
list_colours = c("#BF7EBE", "#FFBF7F", "#8BA5F2", "#FF7F7E", "#78C679")

### Iterate across herbicides
for (i in 1:length(list_herbicides)){
  # i = 2
  name_herbicide = list_herbicides[i]
  colour_herbicide = list_colours[i]
  
  df_farmer = dat[dat$Farmer_Agronomist==name_farmer, c(1:12, grep(name_herbicide, colnames(dat)))]
  df_farmer = df_farmer[!is.na(df_farmer[, grepl("_SURVI", colnames(df_farmer))]), ]
  df_farmer = df_farmer[order(df_farmer[, grepl("_SURVI", colnames(df_farmer))], decreasing=FALSE), ]
  
  vec_resistance = dat[, grep(paste0(name_herbicide, "_SURVI"), colnames(dat))]
  vec_resistance = vec_resistance[!is.na(vec_resistance)]
  
  if (nrow(df_farmer)==0){
    next
  }
  ### title
  plot_herbicide_name(name_herbicide, colour_herbicide, cex.title=2, df_herbi_specs, df_farmer, cex.sub=1)
  ### histogram
  vec_percentiles = plot_hist(vec_resistance, name_herbicide, colour_herbicide, df_farmer)
  ### population names
  plot_legend(vec_percentiles, colour_herbicide, cex.text=1)
  ### heat map
  color_gradient = plot_heatmap(name_herbicide, df_farmer)
  ### heat map legend
  plot_heatmap_legend(color_gradient)
  ### description
  plot_description(name_herbicide, colour_herbicide, df_herbi_specs, df_farmer, cex.text=1.4, width=75)
  ### spacer
  plot(x=c(-1,1), y=c(-1,1), type="n", xaxt="n", yaxt="n", xlab="", ylab="", bty="n")
  rect(xleft=-1, ybottom=-1, xright=1, ytop=1, col="#fefefefe", border=NA)
}
```



